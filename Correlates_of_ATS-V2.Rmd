---
title: "Correlates of Walking to School"
author: "John Williams"
bibliography: /home/john/Dropbox/Writing/bib/all-refs.bib
csl: /home/john/Dropbox/Writing/bib/CSL/styles-distribution-master/apa.csl
output: 
  Grmd::docx_document:
    fig_caption: TRUE
    force_captions: TRUE
    toc: TRUE
    toc_depth: 5
  pdf_document:
    toc: true
    latex_engine: xelatex
    keep_tex: true
---

```{r label=R-setup, echo=FALSE, include=FALSE, cache=FALSE}
# bibliography: /home/john/Dropbox/Writing/bib/all-refs.bib
require( ggplot2 )
require( scales )
require( Gmisc )
require( rms )
require( knitr )

# Evaluate the figure caption after the plot
knitr::opts_knit$set(eval.after='fig.cap')

# Use the table counter that the htmlTable() provides
options(table_counter = TRUE)

# Use the figCapNo() with roman letters
options(fig_caption_no_roman = TRUE)

#theme_set( theme_gray( base_size = 10 ))
#theme_update( legend.key.width = unit( 3,"line") )
options(width=120)
options("show.signif.stars"=F)

## set global chunk options
opts_chunk$set(echo=FALSE,
               cache=TRUE,
               dpi=96,
               fig.height=5,
               fig.width=7,
               prompt=F,
               tidy=T,
               highlight=T,
               dev="png",
               dev.args=list(type="cairo"),
               fig.align='center',
               fig.show='hold',
               par=TRUE,
               comment=NA,
               background="wheat",
               prompt=TRUE,
               warning=FALSE,
               message=FALSE)

info   <- sessionInfo()
r_ver  <- paste(info$R.version$major, info$R.version$minor, sep=".")
barcol <- "wheat"
source("/home/john/Dropbox/Writing/Software//R/logistic-regression-functions.R")
```

# Correlates of Active Transport to School

## Data Setup
The **R** code below is just to show which data file is being used.

```{r label="read-data", results='hide', echo=2:4, size="small", prompt=FALSE}
require(foreign)
dir  <- "/home/john/Dropbox/Research/Collaboration/BEATS/John/W2S"
file <- "BEATS_SS_ForWalk2School_150506.sav"
dat <- read.spss( paste(dir, file, sep="/"), to.data.frame=TRUE )
rm(dir, file)
```


```{r label=data-setup, results='hide', cache=TRUE, dependson="read-data"}
source( "data-setup.R" )
```

## Introduction

This document contains preliminary analyses of correlates of walking to school. 
We know from previous work (and common sense!) that the most influential 
correlate is distance from school. But once that is factored out, what else is 
influential?

```{r label=ATS-Dist, dependson="data-setup", fig.cap="Figure 1: Empirical probability of ATS by distance from school", fig.width=5}
emp <- NULL
plot_cutoff <- 8000
with( dat.full[dat.full$Dist2School <= plot_cutoff, ],
      {
        for ( i in 1:length(Dist2School ) ) 
           emp[i] <- prop.table(table(ATS_f[ Dist2School < Dist2School[i]]))["Walk"]
        emp_prob <- data.frame( dist=Dist2School, true=ATS_f, prob=emp )
        p <- ggplot( emp_prob, aes( dist, prob) ) 
        p <- p + labs(x="Distance from School (m)", y="Probability of ATS", 
                      title="Empirical probability of ATS")
        p <- p + geom_point(size=1) 
        p + geom_smooth( size=1, method="gam", formula= y ~ s( x, bs = "cs") )
        }
      )
```

The figure above shows the empirical probability of walking to school, i.e. the 
proportion of respondents walk at each level of distance to school. The 
observations plotted are those respondents who live less than 
`r I(plot_cutoff)`m from school. The blue line is a Generalised Additive Model 
smoother.  

## Descriptive statistics

The analyses below are restricted to the students who live less than 
`r I(cutoff)`m from school, and who are not boarders. There are
`r I(dim(dat.ats)[ 1 ])` students who fit those criteria.

```{r label="descriptives", dependson="data-setup", cache=FALSE}
require( Gmisc )
res <- data_setup( dat.ats[,-1], dat.ats$ATS_f )
(tab1 <- htmlTable(x = res$tab,
  rgroup   = res$rgroup,
  n.rgroup = res$ngroup,
  label    = "Table1",
  caption  = "Individual and household potential correlates of walking to school",
  tfoot    = "<span style='font-size: 80%'>&dagger;All continuous variables are reported with mean and standard deviation: x&#772; (SD). Categorical variables are reported in counts and percentages: count (%). The <i>p</i>-values are from Fisher tests for categorical variables and Wilcoxon tests for continuous variables.</span>",
  rowlabel = "Variable<sup>&dagger;</sup>",
  css.rgroup = "font-weight: 100",
  ctable   = TRUE ))
rm( tab1 )
```


## Modeling
**Note**: following @hosmer13 [p. 177], models with areas under the 
ROC curve greater than 0.9 are labelled "outstanding", and those with ROC areas
between 0.8 and 0.9 are labelled "excellent".

### Model 1
Following best practice (not *common* practice), as explained by 
@harrell01 [pp. 56--60], all significant univariate correlates from Table 1 were 
included in the inital model.

```{r ATS-m1, dependson=c("data-setup"), results='asis', collapse=TRUE}
options(contrasts=c("contr.treatment", "contr.treatment"))
dat.m1   <- dat.ats[ complete.cases(dat.ats), ]
m1.ddist <- datadist(dat.m1)
options(datadist="m1.ddist")
m1 <- lrm(ATS_f ~ rcs( Dist2School, knots=3)
          + BMI_f + n_cars + NZDepCat3 + school_decile_n 
          + whodecides + control + schiclose + closest 
          + interesting + pleasant + boring + useful + safe + exercise 
          + onway + stuff + sched + planning + sweaty + unsafe + tired 
          + desire + confd 
          + adults + parents_walk + parents_safe 
          + parents_say + friends_say + school_says + cool + friends_dont 
          + weather + hills + regwalk 
          + NEStConnect + NGEsthetics, 
          x=T, y=T, data=dat.m1 )
m1.gof <-LR.summary( m1, html = T )
```

This model was reduced by removing the correlate with the largest *p*-value
one at a time and re-inspecting the fit carefully. This was not a purely 
automatic or data-driven process. At each stage, the conceptual meaning of the
candidate variable for removal was considered.  During this process, it became
apparent that two of the correlates, *time* and *intention* are highly correlated
with distance and with each other, even though their VIFs are well below 10. Also
these variables have little explanatory power conceptually. Accordingly they were
removed at the earliest stage of model simplification.

### Model 2
The variables that survived this process and remained significant at the 5% level
are shown below, in model 2.
```{r ATS-m2, dependson=c("data-setup", "ATS-m1"), results='asis'}
attach(dat.ats)
options(contrasts=c("contr.treatment", "contr.treatment"))
dat.m2 <- dat.ats[ complete.cases(ATS_f, Dist2School, BMI_f, n_cars, onway, 
                                  sched, planning, confd, adults, parents_say, 
                                  cool, regwalk), c("ID", "ATS_f", "Dist2School",
                                                    "BMI_f", "n_cars","onway", 
                                                    "sched", "planning", 
                                                    "parents_say", "cool",
                                                    "regwalk") ]
detach(dat.ats)
m2.ddist <- datadist(dat.m2)
options(datadist="m2.ddist")
m2 <- lrm(ATS_f ~ rcs(Dist2School, 3) + BMI_f
          + n_cars + onway + sched + planning 
          + parents_say + cool + regwalk, 
          x=T, y=T, data=dat.m2 )
m2.gof <-LR.summary(m2, html=T )
```

<center>
```{r m2-results-table, cache=FALSE, results='asis'}
#LR.summary(m_final, table=T, print=F)
htmlTable(OR(m2, Dist2School=c(2000,6000)), label="OR-M2", caption="Odds ratios<sup>&dagger;</sup> (Model 2)",
          tfoot="<small><sup>&dagger;</sup> Odds ratios are functions of the difference column, not the usual 1-unit calculation. The low and high values are the IQRs (except for distance, where the low and high values were chosen for clarity of interpretation).</small>")
```
</center>

The plots below show the influence of each correlate on the log-odds.

```{r ATS-M2-OR-logit-plot, dependson=c("ATS-M2", "data-setup"), fig.width=7}
options(datadist="m1.ddist")
plot(Predict(m2))
```

#### Interpretation
Model 2 has absolutely outstanding predictive and discriminant validity, and all 
effects can be interpreted *ceteris paribus*. It also has good face validity.
Apart from the obvious effect of distance
(`r I(OR.inline(OR(m2, Dist2School=c(2000,6000))["Dist2School",], 3))`)
and availability of private transport
(`r I(OR.print(m2, "n_cars", 2))`)
, logistical factors (school being on 
the way to somewhere else,
(`r I(OR.print(m2, "onway", 2))`)
most probably work, or the school of a sibling)  and the difficulty of fitting
walking into the student's after-school schedule 
(`r I(OR.print(m2, "sched", 2))`)
and planning
(`r I(OR.print(m2, "planning", 2))`)
decrease the likelihood of walking to school. However 
peer approval
(`r I(OR.print(m2, "cool", 2))`), 
being a walker for general mobility
(`r I(OR.print(m2, "regwalk", 2))`), 
and having parental support or encouragement to walk 
(`r I(OR.print(m2, "parents_say", 2))`)
increase the likelihood of ATS.

### Model 3
However the 5% level leaves to much room for Type I error due to sample size and
alpha inflation, so the 1% level was used to avoid these problems.  Again, 
regardless of *common practice* this is a wise strategy to avoid false positives
and non-replicable scientific research [@ioannidis05].

Both **sched** and **planning** are related to logistical problems and they are
highly correlated. When including only one of the two, **sched** gives a lower
AIC and is also more specifically interpretable, so I have chosen to include it.
If both are included in Model 3, neither are significant at the 1% level.

```{r ATS-final, dependson=c("ATS-m2", "data-setup"), results='asis'}
options(datadist="m2.ddist")
m3 <- lrm( ATS_f ~ rcs(Dist2School, 3)
          + onway + sched + parents_say + regwalk,
          x=T, y=T, data=dat.m2 )
m_final <- m3
m_final_gof <- LR.summary(m_final, html=TRUE )
```

The bootstrap validation shown below indicates the bias-corrected indices
are not very different from the model indices.

```{r label=ATS-final-validate, dependson="ATS-final",results='asis'} 
s <- validate( m_final, B=200 )
myHTML( s)
```

The figure below represents the odds ratios and confidence intervals graphically.

```{r ATS-OR-plot, dependson=c("ATS-final", "data-setup"),fig.width=6.5}
plot(summary(m_final))
```

The figure below shows the relationship of the log odds to each of the 
correlates (except distance) in the final model with shaded areas indicating 95%
confidence intervals.

```{r ATS-OR-logit-plot, dependson=c("ATS-final", "data-setup"),fig.width=6.5}
options(datadist="m1.ddist")
res <- Predict(m_final)
#plot(res[res$.predictor != "Dist2School", ])
plot(res)
m4.gof <- LR.summary(update(m_final, . ~ . - rcs(Dist2School,3)), print=F )
```

As a final comment, one may think that because distance has such a large 
influence on walking to school, that the additional variables in the final model 
do not have much explanatory power in relative terms. However this is not true. 
Removing distance to school from the final model still gives an ROC value of 
`r I(m4.gof$ROC)`%, which is still outstanding.

<center>
```{r final-results-table, dependson=c("ATS-final"), results='asis'}
htmlTable(OR(m_final, Dist2School=c(2000,6000)), label="Table2", caption="Odds ratios<sup>&dagger;</sup> (final model)",
          tfoot="<small><sup>&dagger;</sup> Odds ratios are functions of the difference column, not the usual 1-unit calculation. The low and high values are the IQRs (except for distance, where the low and high values were chosen for clarity of interpretation).</small>")
```
</center>

#### Interpretation 
In summary, the final model has absolutely outstanding predictive and 
discriminant validity, and all effects can be interpreted *ceteris paribus*. It 
also has good face validity.  Apart from the obvious effect of distance, 
logistical factors (school being on the way to somewhere else 
(`r I(OR.print(m_final, "onway", 2))`)
most probably work, or the school of a sibling)  and the difficulty of fitting
walking into the student's after-school schedule 
(`r I(OR.print(m_final, "sched", 2))`)
decrease the likelihood of walking to school. However being a walker for general 
mobility
(`r I(OR.print(m_final, "regwalk", 2))`), 
and having parental support or encouragement to walk 
(`r I(OR.print(m_final, "parents_say", 2))`)
increase the likelihood of ATS.

The final model suggests that parental factors of encouragement to walk to 
school, and to walk for general mobility, will be the most influential factors in 
promoting walking to school among New Zealand secondary school students. If this
encouragement was genuine, then the barriers of convenience and after-school
schedule would not apply: students could be dropped of somewhere other than the
school gate in the morning, and picked up after school. Then, at least half the
time they would be walking.

It is relevant to note that there were many other "healthy lifestyle"" factors
that were unrelated to walking to school. No variables in the nutrition or 
physical activity sections of the questionnaire influence the likelihood of 
walking, for example.

## Summary
All logistic regression modelling results are exceptionally good in terms of 
disrimination, predictive ability and face validity. However following modern 
best practice for reporting robust results by eschewing mindless use ofthe 
"5% rule", I *strongly* recommend using Model 3 for any in-depth  
interpretation.  

Also, if time permits, I would really like to re-run these 
models excluding distances where either everyone walks (about 500m) or no-one 
walks (about 5000m).  That would reduce the sample size somewhat, but I feel it
would also increase both the substantive and statistical validity and robustness
of modelling results.

```{r walkstats, results='asis', cache=TRUE}
walk_min <- 469 
walk50   <- 3100
walk_max <- 5800 

tmp <- dat$ATS_f[dat$Dist2School <= walk_min]
walk_min_n <- sum(table(tmp))

tmp <- dat$ATS_f[dat$Dist2School <= walk50  ]
walk50_n   <- sum(table(tmp))
```

Of the  `r I(walk_min_n)` students who live less than `r I(walk_min)`m from 
school, all  walk to school. Of the `r I(walk50_n)` who live less than 
`r I(walk50)`m, 50% walk.  Finally, no-one who lives more than `r I(walk_max)`m
from school walks.

## Colophon

All analyses were performed using R (ver. `r r_ver`) @R15 and 
packages rms (ver. `r info$otherPkgs$rms$Version`) @rms15 for 
analysis, Gmisc for plot and table output (ver. `r info$otherPkgs$Gmisc$Version`), 
research.
and knitr (ver `r info$otherPkgs$knitr$Version`) @xie14 for reproducible 

## References
