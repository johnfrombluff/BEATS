---
title: "Correlates of Walking to School"
author: "John Williams"
output: 
  html_document:
    toc: true
    number_sections: true
  Grmd::docx_document:
    fig_caption: TRUE
    force_captions: TRUE
    toc: TRUE
    toc_depth: 5
  pdf_document:
    toc: true
    latex_engine: xelatex
    keep_tex: true
bibliography: /home/john/Dropbox/Writing/bib/all-refs.bib
csl: /home/john/Dropbox/Writing/bib/CSL/apa.csl

---

```{r label=R-setup, echo=FALSE, include=FALSE, cache=FALSE}

# bibliography: /home/john/Dropbox/Writing/bib/all-refs.bib
require( ggplot2 )
require( scales )
require( Gmisc )
require( rms )
require( knitr )
require( JMisc )
# Evaluate the figure caption after the plot
knitr::opts_knit$set(eval.after='fig.cap')

# Use the table counter that the htmlTable() provides
options(table_counter = TRUE)

# Use the figCapNo() with roman letters
options(fig_caption_no_roman = TRUE)

#theme_set( theme_gray( base_size = 10 ))
#theme_update( legend.key.width = unit( 3,"line") )
options(width=120)
options("show.signif.stars"=F)

## set global chunk options
opts_chunk$set(echo=FALSE,
               cache=FALSE,
               dpi=96,
               fig.height=5,
               fig.width=7,
               prompt=F,
               tidy=T,
               highlight=T,
               dev="png",
               dev.args=list(type="cairo"),
               fig.align='center',
               fig.show='hold',
               par=TRUE,
               comment=NA,
               background="wheat",
               prompt=FALSE,
               warning=FALSE,
               message=FALSE)

info   <- sessionInfo()
r_ver  <- paste(info$R.version$major, info$R.version$minor, sep=".")
barcol <- "wheat"
require(JMisc)
```

# Notes to the research team
This file contains two things:

1. A record of the analyses that I've done, with full details of the statistical
results.  More details can be shown on request
2. Snippets that can be copied and pasted into manuscripts.  (Note the abstract 
is at the end because the numbers in the abstract rely on code occurs earlier in
this file.)

All analyses were performed using **R**, ver. `r r_ver` [@R15] with packages 
rms, ver. `r info$otherPkgs$rms$Version` [@rms15] for  analysis; 
Gmisc, ver. `r info$otherPkgs$Gmisc$Version` for plot and table output; and 
knitr, ver `r info$otherPkgs$knitr$Version` [@xie14] for reproducible research.

## Reproducible research
This file is automatically generated, i.e. all the in-text numbers, tables and
graphs are generated from the data.  If the data file changes, or we decide to 
analyse a different subset of the data, or include or exclude certain variables,
the content in  the document will change automatically (almost), i.e. without
the need to re-type anything.

"Weaving" text, code and results together and rendering them into a document is 
known as "reproducible research", i.e. there is code in the source file that 
reads the data and performs the analysis, then generates the document. This 
makes your research report more tightly bound to the data, and makes it less 
likely that you will be unable to reproduce or extend your research in the 
future if the need arises (as it often does, in my experience). You can open 
the file with the same name as this one, but the extension ".Rmd" 
to see the  source file which is compiled into HTML by **R**. 

This approach can also generate PDF (which some journals accept), but as yet 
there is no one-step  method for rendering directly to an editable format, e.g. 
odt, rtf or docx. But  it's easy to simply copy and paste from your web-browser 
into your word-processor. But of course you should not do this until everyone
involved  with the manuscript preparation is happy that the results are 100% 
finalised!

## Data Setup
The **R** code below is just to show which data file is being used.

```{r label="read-data", echo=2:4, size="small", prompt=FALSE, cache=TRUE}
require(foreign)
dir  <- "/home/john/Dropbox/Research/Collaboration/BEATS/John/W2S"
#file <- "BEATS_SS_ForWalk2School_150507.sav"
file <- "BEATS_SS_ForWalk2School_160201_COMPLETEdata.sav"
dat <- read.spss( paste(dir, file, sep="/"), to.data.frame=TRUE )
rm(dir, file )
```


```{r label=data-setup, results='hide', cache=FALSE}
source( "data-setup-W2S.R" )
```

# Introduction

We know from previous work (and common sense!) that the most influential 
correlate is distance from school. But once that is factored out, what else is 
influential?

```{r label=ATS-Dist, dependson="data-setup", fig.cap="Figure 1: Empirical probability of ATS by distance from school", fig.align='center'}
emp <- NULL
plot_cutoff <- 10000

with( dat.full[ dat.full$Dist2School <= plot_cutoff, ],
      {
        for ( i in 1:length(Dist2School ) ) 
           emp[i] <- prop.table(table(ATS_f[ Dist2School < Dist2School[i]]))["Walk"]
        emp_prob <- data.frame( dist=Dist2School, true=ATS_f, prob=emp )
        p <- ggplot( emp_prob, aes( dist, prob) ) 
        p <- p + labs(x="Distance to school (m)", y="Probability of Walking to School" )
        p <- p + geom_point(size=1) 
        p <- p + geom_smooth( size=1, method="gam", formula= y ~ s( x, bs = "cs") )
        p <- p + annotate("text", label="Optimal distance\nthreshold: ≤ 2,200m\nSensitivity: 84%\nSpecificity: 84%\nAUC: 93%", x=4000, y=0.8, hjust="l")
        p <- p + geom_vline(xintercept=2200) 
        print(p)
        }
      )
```

The figure above shows the empirical probability of walking to school, i.e. the 
proportion of respondents walk at each level of distance to school. The 
observations plotted are those respondents who live less than 
`r I(format(plot_cutoff, big.mark=","))`m from school to make the plot more interpretable. The blue 
line is a Generalised Additive Model smoother.  

```{r walkstats, results='asis', cache=FALSE}
walk_min <- 469 
walk_50  <- 3100
walk_max <- 5800 

tmp <- dat$ATS_f[dat$Dist2School <= walk_min]
walk_min_n <- sum(table(tmp))

tmp <- dat$ATS_f[dat$Dist2School <= walk_50  ]
walk_50_n  <- sum(table(tmp))

tmp <- dat$ATS_f[dat$Dist2School > walk_max  ]
walk_max_n <- sum(table(tmp))
```

Of the  `r I(walk_min_n)` students who live less than `r I(walk_min)`m from 
school, all  walk to school. Of the `r I(walk_50_n)` who live less than 
`r I(walk_50)`m, 50% walk.  Finally, of the `r I(walk_max_n)` students who live
more than `r I(walk_max)`m from school, none of them walk to school.

# Sample description

## Exclusion of cases and missing value analysis

The analyses below are restricted to the students who are not boarders. There are
`r I(format(dim(dat.ats)[ 1 ], big.mark=","))` students who fit those criteria. 
The table below shows the number of missing values on variables to be included 
in the multivariate  analyses, which reduce the available sample size.

<center>
```{r mva, dependson="data-setup", cache=FALSE}
# 2 obs  (9078, 9038) had missing aGender but non-missing gender; and missing 
# age_cat but non-missing school year, DOB_day, DOB year ats. I entered 12.5 
# for Age_Cat
# 4 (9165, 4002, 1034, 10152) had missing values for all WSC sections etc. 
# Maybe they didn't finish the questionnaire?
# 11 (9165, 4002, 1034, 10152, 9104, 3027, 9010, 8141, 8175, 3087, 5108) have
# missing value on W2S section
mva( dat.ats, thr = 4)
```
</center>

The variables with 11 cases missing are due to participants not completing a 
section of the questionnaire (due to time constraints?).  Not all students
consented to, or had time available for, anthropometry, so many of these values 
are missing. It's not clear to me why there are so many missing values for the 
other variables though.

A total of `r I(fmt(dim(dat.ats)[ 1 ]))` adolescents were 
included in the analysis (Age
`r I(round(mean(dat.ats$Age_at_Survey, na.rm=T),1))` ± 
`r I(round(sd(dat.ats$Age_at_Survey, na.rm=T),1))` years; 
`r I(round(100*prop.table(table(dat.ats$gender)),1)["Male"])`% boys; 
`r I(round(100*prop.table(table(dat.ats$eth3)),1)["NZ European"])`% New Zealand European; 
`r I(round(100*prop.table(table(dat.ats$BMI_f)),1)["Normal"])`% normal weight). 
The most common modes of transport to school was being driven by others 
(`r I(sum(round(100*prop.table(table(dat.ats$TscCarOth)),1)[4:5]))`%) 
followed by walking 
(`r I(sum(round(100*prop.table(table(dat.ats$TscWalk)),1)[4:5]) )`%), 
school bus (`r I(sum(round(100*prop.table(table(dat.ats$TscBusSc)),1)[4:5]))`%), 
public bus (`r I(sum(round(100*prop.table(table(dat.ats$TscBusPub)),1)[4:5]))`%)
and driving themselves 
(`r I(sum(round(100*prop.table(table(dat.ats$TscCarMy)),1)[4:5]))`%).
Overall, 
`r I(round(100*prop.table(table(dat.ats$ATS)),1)[1])`%
of adolescents used motorized transport only, 
`r I(round(100*prop.table(table(dat.ats$ATS)),1)[2])`% 
W2S, and 
`r I(round(100*prop.table(table(dat.ats$ATS)),1)[3])`% 
used a combination of motorized and active transport to school. Most students 
(`r I(round(100*prop.table(table(dat.ats$TSlike)),1)["Yes"])`%) 
liked the way they travelled to school. 


## Potential correlates 
Socio-demographic characteristics of students who walked versus did not walk to 
school are presented in Tables 2, 3 and 4.

<center>
```{r label="descriptives-demos", cache=FALSE}
require( Gmisc )
n.w  <- table(dat.ats$ATS_f)[2]
n.dw <- table(dat.ats$ATS_f)[1]
res  <- data_setup( dat.ats,  "ATS_f", c("Age_at_Survey", "gender", "eth3", 
                                         "BMI_2cat", "cars3", "NZDepCat3", 
                                         "tsdecision","Dist2School"))
(tab1 <- htmlTable(x = res$tab,
  rgroup   = res$rgroup,
  n.rgroup = res$ngroup,
  label    = "Table1",
  caption  = "Demographic characteristics of the sample.",
  tfoot    = "<small><sup>&dagger;</sup>Categorical variables are reported in counts and percentages: count (%). The <i>p</i>-values are from Fisher tests. Proportions are calculated horizontally. Continuous variables are reported as mean (±SD). The <i>p</i>-values are from Wilcoxon tests.</small>",
  rowlabel = "Variable<sup>&dagger;</sup>",
  css.rgroup = "font-weight: 100",
  #cgroup   = c(n.dw,             n.w, ""),
  #n.cgroup = c(1,                1, 1 ),
  ctable   = TRUE ))
```
</center>

The tables below are not intended for inclusion in manuscripts, they are just 
here for reference in case we decide to change anything else.

<center>
```{r label="descriptives-cat", cache=FALSE}
require( Gmisc ) 
res <- data_setup( dat.ats, "ATS_f", c("school", "BMI_f", "BMI_2cat","HMcars", "ScrGuide",
                                       "whodecides", "schiclose"))
(tab1 <- htmlTable(x = res$tab,
  rgroup   = res$rgroup,
  n.rgroup = res$ngroup,
  label    = "Table1",
  caption  = "Categorical individual and household potential correlates of walking to school",
  tfoot    = "<small><sup>&dagger;</sup>Variables are reported in counts and percentages: count (%). The <i>p</i>-values are from Fisher tests. The total proportions are calculated vertically, and the others are calulated horizontally.</small>",
  rowlabel = "Variable<sup>&dagger;</sup>",
  css.rgroup = "font-weight: 100",
  ctable   = TRUE ))
rm( tab1 )
```
</center>

&nbsp;

<center>
```{r descriptives-cont, cache=FALSE}
require( Gmisc )
res <- data_setup( dat.ats , "ATS_f", names(dat.ats)[c(16, 13:14, 17:50)])
(tab2 <- htmlTable(x = res$tab,
  rgroup   = res$rgroup,
  n.rgroup = res$ngroup,
  label    = "Table1",
  caption  = "Continuous individual potential correlates of walking to school",
  tfoot    = "<small><sup>&dagger;</sup>The <i>p</i>-values are from  Wilcoxon tests.</small>",
  rowlabel = "Variable<sup>&dagger;</sup>",
  css.rgroup = "font-weight: 100",
  ctable   = TRUE ))
rm( tab2 )
```
</center>

# Modeling
Notes:

- The effect of distance on the probability of walking to school is clearly 
non-linear, so the distance variable was transformed using a restricted cubic 
spline (with three knots).
- Because the data were collected within schools, robust standard errors were 
calculated using school as a cluster variable. 
- Following @hosmer13 [p. 177], models with areas under the  ROC curve greater 
than 0.9 are labelled "outstanding", and those with ROC areas between 0.8 and 
0.9 are labelled "excellent".

## Model 1
Following best practice (not *common* practice), as explained by 
@harrell01 [pp. 56--60], all significant univariate correlates from Table 1 were 
included in the initial model. This model was reduced by removing the correlate 
with the largest *p*-value one at a time and re-inspecting the fit carefully. 

This was not a purely automatic or data-driven process. At each stage, the 
conceptual meaning of the candidate variable for removal was considered.  During 
this process, it became apparent that two of the correlates, **time** and 
**intention** are highly correlated with distance and with each other, even though 
their VIFs are well below 10. Also these variables have little explanatory power 
conceptually. Accordingly they were removed at the earliest stage of model 
simplification.

```{r ATS-m1, dependson=c("read-data"), results='hide', cache=TRUE}
options( contrasts=c("contr.treatment", "contr.treatment"))
dat.m1   <- dat.ats[ complete.cases(dat.ats), ]
m1.ddist <- datadist(dat.m1)
options(datadist="m1.ddist")
m1 <- robcov(lrm(ATS_f ~ rcs( Dist2School, knots=3)
          + BMI_f + n_cars + NZDepCat3 + school_decile_n 
          + whodecides + control + schiclose 
          + interesting + pleasant + boring + useful + safe + exercise 
          + onway + stuff + sched + planning + sweaty + unsafe + tired 
          + desire + confd 
          + adults + parents_walk + parents_safe 
          + parents_say + friends_say + school_says + cool + friends_dont 
          + weather + hills + regwalk 
          + NEStConnect + NGEsthetics, 
          x=T, y=T, data=dat.m1 ), dat.m1$school)
m1.gof <- LR.summary( m1, html = T, anova=F )
```

<center>
```{r m1_gof, cache=FALSE}
htmlTable(m1.gof$sf, 
          rnames=F, 
          align="r", 
          header=c("Index", "<span style='padding:5mm'/>", "Statistic", "<span style='padding:5mm'/>"), 
          caption="Inital model goodness of fit and summary information")
```
</center>


<center>
```{r m1_anova, results='asis'}
#aov2html( m1 )
```
</center>
  
## Model 2
The variables that survived this process and remained significant at the 5% 
level are shown below, in model 2. Although the goal was to reduce the set of 
correlates to only those significant at the 5% level, meeting that criteria 
resulted in a set which was also significant at the 1% level.

```{r ATS-m2, dependson=c("data-setup", "ATS-m1"), results='asis', cache=TRUE}
attach(dat.ats)
dat.m2 <- dat.ats[ complete.cases(ATS_f, Dist2School, 
                                  BMI_2cat, 
                                  onway, sched, planning, 
                                  confd, parents_say, cool, regwalk), 
                   c("ID", "ATS_f", "Dist2School",
                     "BMI_2cat",
                     "onway", "sched", "planning",
                     "confd", "parents_say", "cool", "regwalk", 
                     "school") ]
detach( dat.ats )
sc <- dat.m2$school
m2.ddist <- datadist( dat.m2 )
options( datadist = "m2.ddist", contrasts=c("contr.treatment", "contr.treatment") )
m2 <- robcov(lrm(ATS_f ~ rcs(Dist2School, 3) + BMI_2cat
          + onway + sched + planning 
          + parents_say + cool + regwalk, 
          x=T, y=T, data=dat.m2 ), cluster=sc )
m2.gof <- LR.summary( m2, print=F )
```

<center>
```{r m_final_gof}
htmlTable(m2.gof$sf, 
          rnames=F, 
          align="r", 
          header=c("Index", "<span style='padding:5mm'/>", "Statistic", "<span style='padding:5mm'/>"), 
          caption="Goodness of fit and summary information")
```
</center>

Table `r I(options("table_counter"))` summarises the goodness of fit of Model 2.

<center>
```{r m_final_anova, results='asis', cache=FALSE}
aov2html( m2 )
```
</center>

Table `r I(options("table_counter"))`  shows Wald tests of the covariates. All 
correlates are significant at the 1% level. The 5% level leaves to much room 
for Type I error due to sample size and alpha inflation, so the 1% level was 
used to avoid these problems.  Regardless of *common practice* this is a wise 
strategy to avoid false positives and non-replicable scientific research 
[@ioannidis05].


```{r ATS-final, dependson=c("ATS-m2", "data-setup"), results='asis', cache=TRUE}
m_final <- m2
m_final_gof <- LR.summary( m_final, print=FALSE )
#htmlTable(round(anova(m_final), 3))
```

To address the possibility of over-fitting, bias-corrected goodness of fit 
indices were calculated using `r validate_n<-20; I(validate_n)` bootstrap 
samples. (**NB**: currently this is set rather low, so that this file will
compile  quickly. I will update it to be larger if required, but I've previously 
inspected the calibration results with *n*=200, giving the same substantive 
conclusion.)

<center>
```{r label=ATS-final-validate, dependson="ATS-final",results='asis', cache=F} 
s <- validate( m_final, B=validate_n )
colnames(s) <- c("Model", "Training", "Test", "Optimism", "Corrected", "n")
rownames(s)[1] <- "R<sub>xy</sub>"
rownames(s)[2] <- "R<sup>2</sup>"
htmlTable( round(s, 3), 
           caption="Model bootstrap calibration", 
           rowlabel="Index",
           align="r",
           label="m_final_calibration")
```
</center>

Table `r I(options("table_counter"))` shows that the bias-corrected indices  are 
very similar to the model indices, hence the results are unlikely to be due to 
over-fitting, and are more likely to be generalisable to new samples from the 
same population.

<center>
```{r m2-results-table, cache=FALSE, results='asis', dependson="ATS-final"}
#LR.summary(m_final, table=T, print=F)
htmlTable( OR(m2, Dist2School=c(4000,5000)), 
          label="OR-M2", 
          caption="Odds ratios<sup>&dagger;</sup>",
          align="r",
          tfoot="<small><sup>&dagger;</sup> Odds ratios are functions of the difference column, not the usual 1-unit calculation. The low and high values are the IQRs (except for distance, where the low and high values were chosen for clarity of interpretation).</small>")
```
</center>

Table `r I(options("table_counter"))` shows the odds ratios from Model 2 and 
Figure 2 below represents the odds ratios and their confidence intervals 
graphically.

```{r ATS-OR-plot, dependson="ATS-final",fig.width=7.5, fig.cap="Figure 2: Odds ratios"}
plot(summary(m_final, Dist2School=c(4000,5000)))
```

Figure 3 below shows how the log odds of W2S varies over the range of the 
correlates in the final model, with shaded areas indicating 95% confidence 
intervals.

```{r ATS-OR-logit-plot, dependson="ATS-final",fig.width=8.5, fig.cap="Figure 3: Effect of covariates on logit"}
options(datadist="m1.ddist")
res <- Predict(m_final)
#plot(res[res$.predictor != "Dist2School", ])
plot(res)
m4.gof <- LR.summary(update(m_final, . ~ . - rcs(Dist2School,3)), print=F )
```


## Interpretation
The final model has absolutely outstanding predictive and discriminant validity, 
and all  effects can be interpreted *ceteris paribus*. It also has good face 
validity. Apart from the obvious effect of distance
(`r I(OR.inline(OR(m_final, Dist2School=c(4000,5000))["Dist2School",], 3))`), 
logistical factors: 

- school being on the way to somewhere else,(**onway**, OR `r I(OR.print(m_final, "onway", 2))`) most probably work, or the school of a sibling) and

- the difficulty of fitting walking into the student's after-school schedule (**sched**, OR `r I(OR.print(m_final, "sched", 2))`)

- planning for walking to school (**planning**, OR `r I(OR.print(m_final, "planning", 2))`)

decrease the likelihood of walking to school. However social and lifestyle factors:

- peer approval (**cool**, OR `r I(OR.print(m_final, "cool", 2))`), 

- having parental support or encouragement to walk (**parents_say**, OR `r I(OR.print(m_final, "parents_say", 2))`)

- being a walker for general mobility (**regwalk**, OR `r I(OR.print(m_final, "regwalk", 2))`), and

increase the likelihood of W2S.  Note that walking for general mobility may be
a lifestyle choice, or a function of lack of alternative mobility options. 
However the correlation between **regwalk** and **n_cars** is only 
`r I(with(dat.ats, myCor(n_cars, regwalk)))` 
(*p* &lt; `r I(fmt_p(with(dat.ats, cor.test(n_cars, regwalk))$p.value))`), 
which gives some evidence that regular walking may not be based largely or 
solely on necessity.

Lastly, BMI has an effect.  The point estimates for ORs of being overweight or 
obese more than halve the odds of W2S. The normal vs. obese comparison is not 
significant, but this is almost certainly due to the lower number of students in 
this category inflating the standard error, as the graphical presentation of ORs
shows.

The final model suggests that parental factors of encouragement to walk to 
school, and to walk for general mobility, will be the most influential factors in 
promoting walking to school among New Zealand secondary school students. If this
encouragement was genuine, then the barriers of convenience and after-school
schedule would not apply: students could be dropped off somewhere other than the
school gate in the morning, and picked up from the school in the afternoon.
Then, at least half the time they would be walking.

It is relevant to note that there were many other "healthy lifestyle" factors
that were unrelated to walking to school. No variables in the nutrition or 
physical activity sections of the questionnaire influence the likelihood of 
walking, for example.

As a final comment, one may think that because distance has such a large 
influence on walking to school, that the additional variables in the final model 
do not have much explanatory power in relative terms. However this is not true. 
Removing distance to school from the final model still gives an ROC value of 
`r I(m4.gof$stats$ROC)`%, which is still outstanding.

# Summary
All logistic regression modelling results are exceptionally good in terms of 
discrimination, predictive ability and face validity. 

But, if time permits, I would really like to re-run these  models excluding 
distances where either everyone walks (about 500m) or no-one  walks (about 
5000m).  That would reduce the sample size somewhat, but I feel it would also 
increase both the substantive and statistical validity and robustness of 
modelling results.

# Abstract
**Results**: Overall, 
`r I(round(100*prop.table(table(dat.ats$ATS)),1)[1])`%
of adolescents in the sample used motorized transport to school, 
`r I(round(100*prop.table(table(dat.ats$ATS)),1)[2])`% 
W2S, and 
`r I(round(100*prop.table(table(dat.ats$ATS)),1)[3])`% 
used both motorized and active transport to school. Univariate correlates of W2S 
included perceptions of walking to school, benefits of exercise, socializing with 
friends, perceived barriers (convenience of being driven, time constraints, 
school bag weight, after-school schedule, planning, sweating, safety concerns, 
being too tired, lack of interest/desire), perceived control, number of adults 
and vehicles at home, encouragement (peers, parents, school), distance, 
perceived neighbourhood environment (land-mix use access, street connectivity, 
aesthetics, hills) and weather. In a multivariate model, 
peer approval (OR [95% CI]: 
(`r I(OR.print(m_final, "cool", 2)) `) and parental encouragement
(`r I(OR.print(m_final, "parents_say", 2))`)
were positively associated with W2S while incompatibility of walking with 
after-school schedule
(`r I( OR.print(m_final, "sched", 2))`)
and convenience of being driven to school on the way to somewhere else
(`r I(OR.print(m_final, "onway", 2) )`)
were negative factors.

# References
